/* eslint-disable */
//prettier-ignore
const ALLOWED_SCRIPTS = [
  'bootstrap:components',
  'bootstrap:hooks',
  'bootstrap:styles',
  'bootstrap:utils'
];

const NODE_MODULES = 'node_modules';
const STATE_FILE = '.yarn-state.yml';

module.exports = {
  factory: require => ({
    hooks: {
      setupScriptEnvironment: (project, scriptEnv) => {
        if (
          ALLOWED_SCRIPTS.includes(scriptEnv?.npm_lifecycle_event) &&
          project.configuration.get('nodeLinker') === 'node-modules'
        ) {
          const fs = require('fs');
          const path = require('path');
          const stateFile = path.join(project.cwd, NODE_MODULES, STATE_FILE);

          if (!fs.existsSync(stateFile)) {
            fs.mkdirSync(path.dirname(stateFile), { recursive: true });
            fs.appendFileSync(stateFile, '# Autogenerated\n', { flag: 'w+' });
            fs.appendFileSync(stateFile, '__metadata:\n');
            fs.appendFileSync(stateFile, '  version: 1\n');
            fs.appendFileSync(stateFile, '  nmMode: classic\n');
          }
        }
      }
    }
  }),
  name: 'plugin-override-state'
};
